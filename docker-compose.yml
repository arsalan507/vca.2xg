version: '3.8'

services:
  # ─── PostgreSQL Database ─────────────────────────────────────────────────
  vca-postgres:
    image: postgres:16-alpine
    container_name: vca-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: viral_content_analyzer
    volumes:
      - vca-pgdata:/var/lib/postgresql/data
      - ./supabase/migrations/self-hosted-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256m
    networks:
      - vca-internal

  # ─── PostgREST (REST API over PostgreSQL) ────────────────────────────────
  vca-postgrest:
    image: postgrest/postgrest
    container_name: vca-postgrest
    environment:
      PGRST_DB_URI: postgres://authenticator:${PGRST_DB_PASS}@vca-postgres:5432/viral_content_analyzer
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_SERVER_PORT: 3000
      PGRST_DB_POOL: 20
      PGRST_DB_POOL_ACQUISITION_TIMEOUT: 10
      PGRST_MAX_ROWS: 1000
    ports:
      - "3001:3000"
    depends_on:
      vca-postgres:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vca-postgrest.rule=Host(`vca-api.2xg.in`) && PathPrefix(`/postgrest`)"
      - "traefik.http.routers.vca-postgrest.entrypoints=http,https"
      - "traefik.http.routers.vca-postgrest.tls=true"
      - "traefik.http.routers.vca-postgrest.tls.certresolver=letsencrypt"
      - "traefik.http.middlewares.vca-postgrest-strip.stripprefix.prefixes=/postgrest"
      - "traefik.http.middlewares.vca-postgrest-cors.headers.accesscontrolallowmethods=GET,HEAD,POST,PATCH,DELETE,OPTIONS"
      - "traefik.http.middlewares.vca-postgrest-cors.headers.accesscontrolallowheaders=Content-Type,Authorization,apikey,Prefer,Accept"
      - "traefik.http.middlewares.vca-postgrest-cors.headers.accesscontrolalloworiginlist=https://vca.2xg.in,http://localhost:5173,http://localhost:5174,http://localhost:5175,http://localhost:5176,http://192.168.68.125:5173,http://192.168.68.125:5174,http://192.168.68.125:5175"
      - "traefik.http.middlewares.vca-postgrest-cors.headers.accesscontrolmaxage=86400"
      - "traefik.http.middlewares.vca-postgrest-cors.headers.addvaryheader=true"
      - "traefik.http.routers.vca-postgrest.middlewares=vca-postgrest-strip,vca-postgrest-cors"
      - "traefik.http.services.vca-postgrest.loadbalancer.server.port=3000"
    deploy:
      resources:
        limits:
          memory: 64m
    networks:
      - vca-internal
      - coolify

  # ─── Backend (Express.js) ────────────────────────────────────────────────
  vca-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vca-backend
    environment:
      PORT: 3001
      DATABASE_URL: postgres://postgres:${DB_PASSWORD}@vca-postgres:5432/viral_content_analyzer
      FRONTEND_URL: ${FRONTEND_URL}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${GOOGLE_SERVICE_ACCOUNT_CREDENTIALS}
      GOOGLE_DRIVE_RAW_FOOTAGE_FOLDER_ID: ${GOOGLE_DRIVE_RAW_FOOTAGE_FOLDER_ID}
      GOOGLE_DRIVE_EDITED_VIDEO_FOLDER_ID: ${GOOGLE_DRIVE_EDITED_VIDEO_FOLDER_ID}
      GOOGLE_DRIVE_FINAL_VIDEO_FOLDER_ID: ${GOOGLE_DRIVE_FINAL_VIDEO_FOLDER_ID}
      JWT_SECRET: ${JWT_SECRET}
      VOICE_NOTES_DIR: /data/voice-notes
    ports:
      - "3000:3001"
    volumes:
      - vca-voice-notes:/data/voice-notes
    depends_on:
      vca-postgres:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vca-backend.rule=Host(`vca-api.2xg.in`) && !PathPrefix(`/postgrest`)"
      - "traefik.http.routers.vca-backend.entrypoints=http,https"
      - "traefik.http.routers.vca-backend.tls=true"
      - "traefik.http.routers.vca-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.vca-backend.loadbalancer.server.port=3001"
    deploy:
      resources:
        limits:
          memory: 128m
    networks:
      - vca-internal
      - coolify

  # ─── Frontend (Mobile-First React App) ───────────────────────────────────
  vca-frontend-v2:
    build:
      context: ./app-v2
      dockerfile: Dockerfile
      args:
        CACHE_BUST: 2026-02-20-v2
        VITE_BACKEND_URL: https://vca-api.2xg.in
        VITE_POSTGREST_URL: https://vca-api.2xg.in/postgrest
        VITE_POSTGREST_JWT: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InNlbGYtaG9zdGVkIiwiaWF0IjoxNzcwNjIyOTY2LCJleHAiOjIwODYxOTg5NjZ9.MlToNcTzEBR0k9NLH3f0dU7RPHvkA_CCMgMwv9pEVxY
        VITE_GOOGLE_CLIENT_ID: 635771661878-goov8fvgqmh595pikf858p5tdn0ppl2h.apps.googleusercontent.com
        VITE_GOOGLE_API_KEY: ${VITE_GOOGLE_API_KEY:-your_api_key_here}
    container_name: vca-frontend-v2
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vca-frontend-v2.rule=Host(`vca.2xg.in`)"
      - "traefik.http.routers.vca-frontend-v2.entrypoints=http,https"
      - "traefik.http.routers.vca-frontend-v2.tls=true"
      - "traefik.http.routers.vca-frontend-v2.tls.certresolver=letsencrypt"
      - "traefik.http.services.vca-frontend-v2.loadbalancer.server.port=80"
    deploy:
      resources:
        limits:
          memory: 32m
    networks:
      - coolify

volumes:
  vca-pgdata:
  vca-voice-notes:

networks:
  vca-internal:
    driver: bridge
  coolify:
    external: true
